name: Deploy to Server

on:
  push:
    branches: [master, main]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'wrangler.toml'
      - 'api/cloudflare_worker.js'
  release:
    types: [published]

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKERHUB_USERNAME }}
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_PATH: ${{ secrets.SERVER_PATH }}

jobs:
  # ============ éƒ¨ç½²åˆ°æœåŠ¡å™¨ ============
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² AI Daily Collector..."
            
            cd ${{ secrets.SERVER_PATH }}
            
            # å¤‡ä»½æ•°æ®
            echo "ğŸ“¦ å¤‡ä»½æ•°æ®..."
            if [ -d "data" ]; then
              tar -czf data/backups/data-$(date +%Y%m%d-%H%M%S).tar.gz data/
            fi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin master
            
            # æ‹‰å–æœ€æ–° Docker é•œåƒ
            echo "ğŸ³ æ‹‰å– Docker é•œåƒ..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/ai-daily-collector:latest
            
            # é‡å¯æœåŠ¡
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            docker-compose down
            docker-compose up -d --build
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose ps
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
            echo "ğŸ“ æ—¶é—´: $(date)"
            echo "ğŸŒ æœåŠ¡åœ°å€: http://${{ secrets.SERVER_HOST }}:8000"
            echo "ğŸ“Š API æ–‡æ¡£: http://${{ secrets.SERVER_HOST }}:8000/docs"

  # ============ éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ (VPS) ============
  deploy-vps:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: easingthemes/ssh-deploy@v4
        with:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USER }}
          PORT: ${{ secrets.VPS_PORT || '22' }}
          TARGET: ${{ secrets.VPS_TARGET || '/opt/ai-daily-collector' }}
          SOURCE: '.'
          EXCLUDE: '.git/,node_modules/,*.log,data/,htmlcov/,.pytest_cache/'

      - name: Restart Service via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |
            cd ${{ secrets.VPS_TARGET || '/opt/ai-daily-collector' }}
            docker-compose pull
            docker-compose up -d --build
            docker system prune -f
            echo "âœ… VPS éƒ¨ç½²å®Œæˆ!"
            
  # ============ éƒ¨ç½²åˆ° Kubernetes ============
  deploy-k8s:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Login to Container Registry
        uses: azure/container-login@v2
        with:
          login-server: ${{ secrets.DOCKERHUB_USERNAME }}.docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull and Deploy to Kubernetes
        run: |
          # æ›´æ–°é•œåƒç‰ˆæœ¬
          kubectl set image deployment/ai-daily-collector \
            ai-daily-collector=${{ secrets.DOCKERHUB_USERNAME }}/ai-daily-collector:latest \
            -n ai-daily-collector
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/ai-daily-collector -n ai-daily-collector
          
          echo "âœ… Kubernetes éƒ¨ç½²å®Œæˆ!"

  # ============ éƒ¨ç½²åˆ° Fly.io ============
  deploy-fly:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Fly.io
        uses: superfly/flyctl-actions@v1
        with:
          args: 'deploy --remote-only'

      - name: Fly.io Status
        run: |
          flyctl status
          echo "âœ… Fly.io éƒ¨ç½²å®Œæˆ!"

  # ============ éƒ¨ç½²åˆ° Zeabur ============
  deploy-zeabur:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Zeabur
        uses: zeabur/zeabur-github-action@v1
        with:
          api-token: ${{ secrets.ZEABUR_API_TOKEN }}
          project-id: ${{ secrets.ZEABUR_PROJECT_ID }}
          service-id: ${{ secrets.ZEABUR_SERVICE_ID }}
          
      - name: Zeabur Status
        run: |
          echo "âœ… Zeabur éƒ¨ç½²å®Œæˆ!"

  # ============ éƒ¨ç½²åˆ° Vercel ============
  deploy-vercel:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./

  # ============ éƒ¨ç½²åˆ° Render ============
  deploy-render:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Render Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: api.render.com
          username: trigger
          key: ${{ secrets.RENDER_DEPLOY_KEY }}
          script: |
            curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys"
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
              -H "Content-Type: application/json"
              -d '{"clearCache": true}'
            echo "âœ… Render éƒ¨ç½²å·²è§¦å‘!"

  # ============ Serverless éƒ¨ç½² (AWS Lambda) ============
  deploy-lambda:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install AWS SAM CLI
        run: |
          pip install aws-sam-cli

      - name: Build and Deploy to AWS Lambda
        run: |
          sam build
          sam deploy --guided
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

  # ============ éƒ¨ç½²åˆ° Railway ============
  deploy-railway:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Railway
        uses: bref-dev/railway-github-action@v1
        with:
          railway-token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE }}
          environment: production

  # ============ éƒ¨ç½²åˆ° Coolify ============
  deploy-coolify:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Trigger Coolify Deploy
        run: |
          curl -X POST "${{ secrets.COOLIFY_API_URL }}/api/v1/projects/${{ secrets.COOLIFY_PROJECT_ID }}/services/${{ secrets.COOLIFY_SERVICE_ID }}/deploy"
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_KEY }}"
            -H "Content-Type: application/json"
            -d '{"pullRequestId": null}'
          echo "âœ… Coolify éƒ¨ç½²å·²è§¦å‘!"

  # ============ éƒ¨ç½²é€šçŸ¥ ============
  notify-deploy:
    runs-on: ubuntu-latest
    needs: [deploy, deploy-vps, deploy-k8s, deploy-fly, deploy-vercel, deploy-render, deploy-lambda, deploy-railway, deploy-coolify]
    if: always()
    
    steps:
      - name: Check deploy status
        id: status
        run: |
          echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆ!"
          echo "ğŸ“ æ£€æŸ¥å„ä¸ª job çš„çŠ¶æ€..."

      - name: Send Discord notification
        if: always()
        uses: appleboy/discord-action@v1
        with:
          webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
          webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
          username: 'AI Daily Deploy Bot'
          content: |
            âœ… **AI Daily Collector éƒ¨ç½²å®Œæˆ!**
            ğŸ“ Commit: ${{ github.sha }}
            ğŸŒ åˆ†æ”¯: ${{ github.ref_name }}
            ğŸ‘¤ ä½œè€…: ${{ github.actor }}
            ğŸ“… æ—¶é—´: $(date)

      - name: Send Telegram notification
        if: always()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
            -H "Content-Type: application/json"
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"âœ… AI Daily Collector éƒ¨ç½²å®Œæˆ!\nğŸ“ Commit: ${{ github.sha }}\",
              \"parse_mode\": \"Markdown\"
            }"

      - name: Send Feishu notification
        if: always()
        run: |
          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}"
            -H "Content-Type: application/json"
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âœ… AI Daily Collector éƒ¨ç½²å®Œæˆ! Commit: ${{ github.sha }}\"
              }
            }"

  # ============ éƒ¨ç½²åˆ° Cloudflare Workers ============
  deploy-cloudflare:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: |
          npm install -g wrangler

      - name: Login to Cloudflare
        run: |
          echo "${{ secrets.CF_API_TOKEN }}" | wrangler login --api-token
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: Create KV Namespace (if not exists)
        run: |
          wrangler kv:namespace create "CACHE" --env CACHE 2>/dev/null || echo "KV namespace may already exist"

      - name: Get KV Namespace ID
        id: kv
        run: |
          KV_ID=$(wrangler kv:namespace list 2>/dev/null | grep -oP '(?<=id: )[a-z0-9-]+' | head -1 || echo "")
          echo "KV_NAMESPACE_ID=$KV_ID" >> $GITHUB_OUTPUT

      - name: Update wrangler.toml with KV ID
        run: |
          if [ -n "${{ env.KV_NAMESPACE_ID }}" ]; then
            sed -i "s/your-kv-namespace-id/${{ env.KV_NAMESPACE_ID }}/g" wrangler.toml
          fi
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        run: |
          wrangler deploy --env production
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Cloudflare Worker Status
        run: |
          echo "âœ… Cloudflare Workers éƒ¨ç½²å®Œæˆ!"
          echo "ğŸŒ URL: https://${{ secrets.CF_WORKER_NAME }}.workers.dev"
          echo ""
          echo "æµ‹è¯•éƒ¨ç½²ç»“æœ:"
          curl -s https://${{ secrets.CF_WORKER_NAME }}.workers.dev/health | head -20

  # ============ éƒ¨ç½²åˆ° Cloudflare Pages ============
  deploy-cloudflare-pages:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: |
          npm install -g wrangler

      - name: Login to Cloudflare
        run: |
          echo "${{ secrets.CF_API_TOKEN }}" | wrangler login --api-token
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: Deploy to Cloudflare Pages
        run: |
          wrangler pages project create ai-daily-collector --production-branch=master 2>/dev/null || true
          wrangler pages deploy ./public --project-name=ai-daily-collector
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Cloudflare Pages Status
        run: |
          echo "âœ… Cloudflare Pages éƒ¨ç½²å®Œæˆ!"
          echo "ğŸŒ URL: https://ai-daily-collector.pages.dev"

  # ============ éƒ¨ç½²é€šçŸ¥ ============
  notify-deploy:
    needs: [deploy, deploy-vps, deploy-k8s, deploy-fly, deploy-vercel, deploy-render, deploy-lambda, deploy-railway, deploy-coolify, deploy-cloudflare, deploy-cloudflare-pages]
    if: always()
