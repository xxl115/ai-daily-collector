name: AI Daily Collection (Scheduled)

on:
  schedule:
    - cron: '0 6 * * *'
    - cron: '0 14 * * *'
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'è§¦å‘åŽŸå› '
        required: false
        default: 'Manual trigger'

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect-and-deploy:
    runs-on: ubuntu-latest
    name: Collect & Deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Generate daily data
        run: |
          mkdir -p data/
          python3 scripts/collect-real.py

      - name: Show results
        run: |
          echo "ðŸ“Š é‡‡é›†ç»“æžœé¢„è§ˆ:"
          if [ -f "data/daily.json" ]; then
            head -50 data/daily.json
            echo ""
            echo "âœ… æ•°æ®æ–‡ä»¶å·²ç”Ÿæˆ"
          else
            echo "âŒ æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f "data/daily.json" ] && [ -s "data/daily.json" ]; then
            git add data/
            git commit -m "AI Daily: $(date '+%Y-%m-%d %H:%M')" || echo "No changes to commit"
            git push origin master || echo "Push failed"
          else
            echo "âš ï¸ No data to commit"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Extract Worker Name
        id: worker-name
        run: |
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          echo "name=$WORKER_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Worker åç§°: $WORKER_NAME"

      - name: Deploy to Cloudflare Workers
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ° Cloudflare Workers..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Verify Deployment
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          echo ""
          echo "================================================"
          echo "âœ… é‡‡é›†ä¸Žéƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ðŸ“ è®¿é—®åœ°å€:"
          echo "   - Worker: https://${WORKER_NAME}.workers.dev"
          echo "   - API: https://${WORKER_NAME}.workers.dev/api/hotspots"
          echo "   - Frontend: https://ai-daily-collector.pages.dev"
          echo "================================================"

      - name: Workflow Summary
        if: always()
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          echo "## ðŸ“Š AI Daily æ•°æ®é‡‡é›†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker**: https://${WORKER_NAME}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯**: https://ai-daily-collector.pages.dev" >> $GITHUB_STEP_SUMMARY
