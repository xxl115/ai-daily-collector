name: AI Daily Collection (Scheduled)

on:
  schedule:
    # æ¯å¤© 6:00, 14:00, 22:00 UTC (åŒ—äº¬æ—¶é—´ 14:00, 22:00, 06:00)
    - cron: '0 6 * * *'
    - cron: '0 14 * * *'
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'è§¦å‘åŽŸå› '
        required: false
        default: 'Manual trigger'

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write
  actions: read

jobs:
  collect-and-deploy:
    runs-on: ubuntu-latest
    name: Collect & Deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          # Remove dev/test dependencies we don't need in CI
          pip uninstall -y pytest pytest-cov pytest-asyncio flake8 black mypy pre-commit ipython fastapi uvicorn pydantic cryptography redis || true
          sudo apt-get install -y jq

      - name: Run AI Daily Collection
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_D1_DATABASE_ID: ${{ secrets.CF_D1_DATABASE_ID }}
          DATABASE_PROVIDER: d1
        run: |
          echo "============================================"
          echo "AI Daily Collector - Scheduled Collection"
          echo "Date: $(date +%Y-%m-%d)"
          echo "============================================"
          echo ""
          python -m ingestor.main --config config/sources.yaml
          echo ""
          echo "âœ… Collection complete!"

      - name: Show results
        run: |
          echo "ðŸ“Š é‡‡é›†ç»“æžœé¢„è§ˆ:"
          echo ""
          if [ -d "ai/articles/original" ]; then
            ARTICLE_COUNT=$(find ai/articles/original -name "*.md" 2>/dev/null | wc -l)
            echo "âœ… æ–‡ç« æ–‡ä»¶: ${ARTICLE_COUNT} ä¸ª"
            echo "   ç›®å½•: ai/articles/original/"
          else
            echo "âš ï¸ æ–‡ç« ç›®å½•æœªåˆ›å»º"
          fi
          echo ""

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-articles
          path: ai/articles/original/

      - name: Commit results
        run: |
          cd ${{ github.workspace }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æäº¤æ–‡ç« æ–‡ä»¶
          if [ -d "ai/articles/original" ]; then
            git add ai/articles/original/ 2>/dev/null || true
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "AI Daily: $(date +%Y-%m-%d)" || echo "Commit failed"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:master || echo "Push failed"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Extract Worker Name
        id: worker-name
        run: |
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          echo "name=$WORKER_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Worker åç§°: $WORKER_NAME"

      - name: Deploy to Cloudflare Workers
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ° Cloudflare Workers..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Verify Deployment
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          echo ""
          echo "================================================"
          echo "âœ… é‡‡é›†ä¸Žéƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ðŸ“ è®¿é—®åœ°å€:"
          echo "   - Worker: https://${WORKER_NAME}.workers.dev"
          echo "   - API: https://${WORKER_NAME}.workers.dev/api/hotspots"
          echo "   - Frontend: https://ai-daily-collector.pages.dev"
          echo "================================================"

      - name: Workflow Summary
        if: always()
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          ARTICLE_COUNT=$(find ai/articles/original -name "*.md" 2>/dev/null | wc -l || echo "0")

          echo "## ðŸ“Š AI Daily æ•°æ®é‡‡é›†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é‡‡é›†æ–‡ç« **: ${ARTICLE_COUNT} ç¯‡" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker**: https://${WORKER_NAME}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯**: https://ai-daily-collector.pages.dev" >> $GITHUB_STEP_SUMMARY
