name: Deploy Cloudflare Worker

on:
  push:
    branches: [master, main]
    paths:
      - 'api/cloudflare_worker.js'
      - 'wrangler.toml'
      - '.github/workflows/cloudflare-deploy.yml'
  workflow_dispatch:

jobs:
  deploy-cloudflare:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Workers
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½² Cloudflare Worker..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Extract Worker Name
        id: worker-name
        run: |
          # ä»Ž wrangler.toml æå– worker åç§°
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          echo "name=$WORKER_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Worker åç§°: $WORKER_NAME"

      - name: Verify Deployment
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          WORKER_URL="https://${WORKER_NAME}.workers.dev"

          echo ""
          echo "â³ ç­‰å¾… Worker ç”Ÿæ•ˆ..."
          sleep 5

          echo "ðŸ§ª å¥åº·æ£€æŸ¥..."
          HEALTH=$(curl -s --max-time 30 "${WORKER_URL}/health" || echo "failed")
          echo "å“åº”: $HEALTH"

          if echo "$HEALTH" | grep -q "ok"; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡!"
          else
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†éƒ¨ç½²å¯èƒ½å·²å®Œæˆ"
          fi

          echo ""
          echo "================================================"
          echo "âœ… éƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ðŸ“ è®¿é—®åœ°å€:"
          echo "   - Worker: $WORKER_URL"
          echo "   - Health: ${WORKER_URL}/health"
          echo "   - API: ${WORKER_URL}/api/hotspots"
          echo "   - RSS: ${WORKER_URL}/rss/latest.xml"
          echo ""
          echo "ðŸ§ª æœ¬åœ°æµ‹è¯•å‘½ä»¤:"
          echo "   curl ${WORKER_URL}/health"
          echo "   curl ${WORKER_URL}/api/hotspots?limit=3"
          echo "================================================"

      - name: Deployment Summary
        if: always()
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          echo "## ðŸš€ Cloudflare Worker éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker åç§°**: \`$WORKER_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²åœ°å€**: https://${WORKER_NAME}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **API ç«¯ç‚¹**: https://${WORKER_NAME}.workers.dev/api/hotspots" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª æµ‹è¯•å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${WORKER_NAME}.workers.dev/health" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${WORKER_NAME}.workers.dev/api/hotspots?limit=3" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
