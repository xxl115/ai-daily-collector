name: Deploy Cloudflare Python Worker

on:
  push:
    branches: [master, main]
    paths:
      - 'worker.py'
      - 'pyproject.toml'
      - 'wrangler.toml'
      - '.github/workflows/cloudflare-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-cloudflare:
    runs-on: ubuntu-latest
    name: Deploy Python Worker to Cloudflare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          version: 'latest'
          enable-cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pywrangler
        run: |
          uv tool install workers-py
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Update wrangler.toml with D1 database ID
        env:
          CF_D1_DATABASE_ID: ${{ secrets.CF_D1_DATABASE_ID }}
        run: |
          if [ -n "$CF_D1_DATABASE_ID" ]; then
            sed -i "s/your-database-id-here/$CF_D1_DATABASE_ID/g" wrangler.toml
            echo "Updated wrangler.toml with D1 database ID"
            echo "Database ID length: ${#CF_D1_DATABASE_ID}"
          else
            echo "CF_D1_DATABASE_ID not set, using placeholder"
            exit 1
          fi

      - name: Verify wrangler.toml
        run: |
          echo "=== wrangler.toml content ==="
          cat wrangler.toml
          echo ""
          echo "=== Checking database_id ==="
          grep "database_id" wrangler.toml

      - name: Deploy to Cloudflare Workers
        run: |
          echo "Starting Cloudflare Python Worker deployment..."
          uv run pywrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Verify Deployment
        run: |
          # 从 wrangler.toml 提取 worker 名称
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          WORKER_URL="https://${WORKER_NAME}.workers.dev"

          echo ""
          echo "Waiting for Worker to be ready..."
          sleep 5

          echo "Testing API endpoints..."
          
          # 测试健康检查
          echo "Testing /health:"
          HEALTH=$(curl -s --max-time 30 "${WORKER_URL}/health" || echo '{"status": "failed"}')
          echo "Response: $HEALTH"
          
          if echo "$HEALTH" | grep -q "healthy"; then
            echo "Health check passed!"
          else
            echo "Health check may need more time"
          fi
          
          # 测试文章列表
          echo ""
          echo "Testing /api/v2/articles:"
          ARTICLES=$(curl -s --max-time 30 "${WORKER_URL}/api/v2/articles?page_size=1" || echo '{"error": "failed"}')
          echo "Response: $ARTICLES"
          
          # 测试统计
          echo ""
          echo "Testing /api/v2/stats:"
          STATS=$(curl -s --max-time 30 "${WORKER_URL}/api/v2/stats" || echo '{"error": "failed"}')
          echo "Response: $STATS"

          echo ""
          echo "================================================"
          echo "Deployment complete!"
          echo ""
          echo "Access URLs:"
          echo "   - Worker: $WORKER_URL"
          echo "   - Health: ${WORKER_URL}/health"
          echo "   - API: ${WORKER_URL}/api/v2/articles"
          echo "   - Stats: ${WORKER_URL}/api/v2/stats"
          echo ""
          echo "Test commands:"
          echo "   curl ${WORKER_URL}/health"
          echo "   curl ${WORKER_URL}/api/v2/articles?limit=3"
          echo "   curl ${WORKER_URL}/api/v2/stats"
          echo "================================================"

      - name: Deployment Summary
        if: always()
        run: |
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          echo "## Cloudflare Python Worker Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker Name**: \`$WORKER_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Runtime**: Python" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment URL**: https://${WORKER_NAME}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- \`${WORKER_URL}/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${WORKER_URL}/api/v2/articles\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${WORKER_URL}/api/v2/stats\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${WORKER_NAME}.workers.dev/health" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${WORKER_NAME}.workers.dev/api/v2/articles?page_size=5" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
