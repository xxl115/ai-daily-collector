name: Deploy Cloudflare Worker (Python)

on:
  push:
    branches: [master, main]
    paths:
      - 'worker.py'
      - 'api/**/*.py'
      - 'config/**/*.py'
      - 'ingestor/storage/**/*.py'
      - 'shared/**/*.py'
      - 'wrangler.toml'
      - '.github/workflows/cloudflare-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-cloudflare:
    runs-on: ubuntu-latest
    name: Deploy Python Worker to Cloudflare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Verify Python syntax
        run: |
          python -m py_compile worker.py
          echo "âœ… Python syntax check passed"

      - name: Update wrangler.toml with D1 database ID
        env:
          CF_D1_DATABASE_ID: ${{ secrets.CF_D1_DATABASE_ID }}
        run: |
          if [ -n "$CF_D1_DATABASE_ID" ]; then
            sed -i "s/your-database-id-here/$CF_D1_DATABASE_ID/g" wrangler.toml
            echo "âœ… Updated wrangler.toml with D1 database ID"
          else
            echo "âš ï¸ CF_D1_DATABASE_ID not set, using placeholder"
          fi

      - name: Deploy to Cloudflare Workers
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½² Cloudflare Python Worker..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Verify Deployment
        run: |
          # ä»Ž wrangler.toml æå– worker åç§°
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          WORKER_URL="https://${WORKER_NAME}.workers.dev"

          echo ""
          echo "â³ ç­‰å¾… Worker ç”Ÿæ•ˆ..."
          sleep 5

          echo "ðŸ§ª æµ‹è¯• API ç«¯ç‚¹..."
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥
          echo "æµ‹è¯• /health:"
          HEALTH=$(curl -s --max-time 30 "${WORKER_URL}/health" || echo '{"status": "failed"}')
          echo "å“åº”: $HEALTH"
          
          if echo "$HEALTH" | grep -q "healthy"; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡!"
          else
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´ç”Ÿæ•ˆ"
          fi
          
          # æµ‹è¯•æ–‡ç« åˆ—è¡¨
          echo ""
          echo "æµ‹è¯• /api/v2/articles:"
          ARTICLES=$(curl -s --max-time 30 "${WORKER_URL}/api/v2/articles?page_size=1" || echo '{"error": "failed"}')
          echo "å“åº”: $ARTICLES"
          
          # æµ‹è¯•ç»Ÿè®¡
          echo ""
          echo "æµ‹è¯• /api/v2/stats:"
          STATS=$(curl -s --max-time 30 "${WORKER_URL}/api/v2/stats" || echo '{"error": "failed"}')
          echo "å“åº”: $STATS"

          echo ""
          echo "================================================"
          echo "âœ… éƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ðŸ“ è®¿é—®åœ°å€:"
          echo "   - Worker: $WORKER_URL"
          echo "   - Health: ${WORKER_URL}/health"
          echo "   - API: ${WORKER_URL}/api/v2/articles"
          echo "   - Stats: ${WORKER_URL}/api/v2/stats"
          echo ""
          echo "ðŸ§ª æµ‹è¯•å‘½ä»¤:"
          echo "   curl ${WORKER_URL}/health"
          echo "   curl ${WORKER_URL}/api/v2/articles?limit=3"
          echo "   curl ${WORKER_URL}/api/v2/stats"
          echo "================================================"

      - name: Deployment Summary
        if: always()
        run: |
          WORKER_NAME=$(grep "^name = " wrangler.toml | sed 's/name = "\(.*\)"/\1/' | tr -d '"')
          echo "## ðŸš€ Cloudflare Python Worker éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker åç§°**: \`$WORKER_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶**: Python" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²åœ°å€**: https://${WORKER_NAME}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API ç«¯ç‚¹" >> $GITHUB_STEP_SUMMARY
          echo "- \`${WORKER_URL}/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${WORKER_URL}/api/v2/articles\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${WORKER_URL}/api/v2/stats\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµ‹è¯•å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${WORKER_NAME}.workers.dev/health" >> $GITHUB_STEP_SUMMARY
          echo "curl https://${WORKER_NAME}.workers.dev/api/v2/articles?page_size=5" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
